<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLasec</title>
    
    {% load static %}
    
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <script src="{% static 'js/app.js' %}"></script>

    <style>
        body.dark-theme {
            background-color: #121212;
            color: white;
        }

        .message {
            cursor: pointer;
            padding: 10px;
            border-bottom: 1px solid #333;
        }

        .message:hover {
            background-color: #2c2c2c;
        }

        #searchBar {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            background-color: #2c2c2c;
            border: 1px solid #444;
            color: white;
        }
        /* ChatGPT dark theme button styling */
.button {
    background-color: #3f3f46; /* Dark gray background for button */
    color: #e5e5e5; /* Light gray text color */
    padding: 8px 16px;
    font-size: 14px;
    font-weight: 500;
    border: none;
    border-radius: 6px; /* Rounded corners for a modern look */
    cursor: pointer;
    transition: background-color 0.3s ease; /* Smooth hover transition */
}

.button:hover {
    background-color: #575767; /* Darker gray on hover */
}

.button:active {
    background-color: #404040; /* Slightly different shade on click */
}

.button-container {
    text-align: center;
    margin: 10px 0;
}

    </style>
</head>
<body class="dark-theme">
    <div class="container mt-5">
        <h2 class="text-center">Plasec</h2>

        <!-- Search bar for filtering messages -->
        <input type="text" id="searchBar" placeholder="Search messages..." onkeyup="searchMessages()">

        <!-- Form to send messages -->
        <form method="POST" class="mt-4">
            {% csrf_token %}
            <div class="mb-3">
                <textarea id="messageInput" name="message" class="form-control" placeholder="Type your message here..." rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Send</button>
        </form>

 
        <!-- Messages -->
        <h3 class="text-center">Messages</h3>
        <div class="messages mt-4">
            {% for message in messages %}
                {% if message.message and "error" not in message.message.lower and message.message != '' %}
                    <!-- Each Play button has a unique class and data attribute for identifying the message -->
                    <button class="playButton btn btn-primary" data-message-id="{{ 1943}}">Play in Telegram</button>
                    <button class="playButton btn btn-primary" data-message-id="{{ 1943}}">Share in Telegram</button>
 
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Get the Play and Share buttons by their IDs
        const playButton = document.getElementById("playButton");
        const shareButton = document.getElementById("shareButton");

        // Add click event listener to the Play button
        playButton.addEventListener("click", function() {
            const messageId = this.getAttribute("data-message-id");
            // Disable button temporarily and show "Sending..." text
            alert("t"+playButton.textContent)
            playButton.disabled = true;
            playButton.textContent = "Sending...";

            fetch('/play_in_telegram/start', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ "message_id": messageId })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.status === 'success' ? 'Play command sent to Telegram!' : 'Error: ' + data.message);
            })
            .catch(error => console.error('Error:', error))
            .finally(() => {
                playButton.disabled = false;
                playButton.textContent = "Play in Telegram";
            });
        });

        
    });
</script>

                    <hr>  

                    <pre id="blockchainDisplay"></pre>
                    <div class="message" onclick="messageClicked('{{ message.id }}')">
                        <strong>User:</strong> {{ message.message }}<br>
                        <strong>Output:</strong> {{ message.response }}<br>
                        <strong>Timestamp:</strong> {{ message.timestamp }}
                        {% if message.topic != 'default_topic' %}
                            <br><strong>Topic:</strong> {{ message.topic }}
                        {% endif %}
                        {% if message.system != 'default_system' %}
                            <br><strong>System:</strong> {{ message.system }}
                        {% endif %}
                        Plasec: {{ message.score }}
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <script>
        // Select all buttons with the "playButton" class and add event listeners to each
        document.addEventListener("DOMContentLoaded", function() {
            const playButtons = document.querySelectorAll(".playButton");
            const startButtons = document.querySelectorAll(".startButton");

            startButtons.forEach(button => {
                button.addEventListener("click", function() {
                    const startButton = this;
                    const messageId = startButton.getAttribute("data-message-id");

                    if (!startButtondisabled) {
                        startButton.disabled = true;  // Disable the button to prevent multiple clicks
                        startButton.textContent = "Sending...";  // Optional: show sending status

                        fetch('/play_in_telegram/', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ "message_id": messageId })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                alert('Play command sent to Telegram!');
                            } else {
                                alert('Error: ' + data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An error occurred while sending the command.');
                        })
                        .finally(() => {
                            startButton.disabled = false;  // Re-enable the button after the action completes
                            startButton.textContent = "Play in Telegram";  // Reset button text
                        });
                    }
                });
            });
            playButtons.forEach(button => {
                button.addEventListener("click", function() {
                    const playButton = this;
                    const messageId = playButton.getAttribute("data-message-id");

                    if (!playButton.disabled) {
                        playButton.disabled = true;  // Disable the button to prevent multiple clicks
                        playButton.textContent = "Sending...";  // Optional: show sending status

                        fetch('/play_in_telegram/', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ "message_id": messageId })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                alert('Play command sent to Telegram!');
                            } else {
                                alert('Error: ' + data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An error occurred while sending the command.');
                        })
                        .finally(() => {
                            playButton.disabled = false;  // Re-enable the button after the action completes
                            playButton.textContent = "Play in Telegram";  // Reset button text
                        });
                    }
                });
            });
        });

        function deleteMessage(messageId) {
            fetch(`/delete_message/${messageId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Message deleted successfully!');
                    location.reload();  // Reload the page to update the message list
                } else {
                    alert('Error deleting message: ' + data.message);
                }
            });
        }

        function messageClicked(messageId) {
            fetch(`/message_clicked/${messageId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Message clicked! New score: ' + data.new_score);
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
        }

        function fetchBlockchain() {
            fetch('/get_blockchain/')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('blockchainDisplay').textContent = JSON.stringify(data, null, 4);
                });
        }
    </script>
</body>
</html>
