<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLasec</title>
    
    {% load static %}
    
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <script src="{% static 'js/app.js' %}"></script>

    <style>
        body.dark-theme {
            background-color: #121212;
            color: white;
        }

        .message {
            cursor: pointer;
            padding: 10px;
            border-bottom: 1px solid #333;
        }

        .message:hover {
            background-color: #2c2c2c;
        }

        #searchBar {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            background-color: #2c2c2c;
            border: 1px solid #444;
            color: white;
        }
        /* ChatGPT dark theme button styling */
.button {
    background-color: #3f3f46; /* Dark gray background for button */
    color: #e5e5e5; /* Light gray text color */
    padding: 8px 16px;
    font-size: 14px;
    font-weight: 500;
    border: none;
    border-radius: 6px; /* Rounded corners for a modern look */
    cursor: pointer;
    transition: background-color 0.3s ease; /* Smooth hover transition */
}

.button:hover {
    background-color: #575767; /* Darker gray on hover */
}

.button:active {
    background-color: #404040; /* Slightly different shade on click */
}

.button-container {
    text-align: center;
    margin: 10px 0;
}

    </style>
</head>
<body class="dark-theme">
    <div class="container mt-5">
        <h2 class="text-center">Plasec</h2>

        <!-- Search bar for filtering messages -->
        <input type="text" id="searchBar" placeholder="Search messages..." onkeyup="searchMessages()">

        <!-- Form to send messages -->
        <form method="POST" class="mt-4">
            {% csrf_token %}
            <div class="mb-3">
                <textarea id="messageInput" name="message" class="form-control" placeholder="Type your message here..." rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Send</button>
        </form>

 
        <!-- Messages -->
        <h3 class="text-center">Messages</h3>
        <div class="messages mt-4">
            {% for message in messages %}
                {% if message.message and "error" not in message.message.lower and message.message != '' %}
                    <!-- Each Play button has a unique class and data attribute for identifying the message -->
                    <button class="playButton btn btn-primary" data-message-id="{{ 23}}">Play in Telegram</button>
                    <button class="playButton btn btn-primary" data-message-id="{{ 1943}}">Share in Telegram</button>
 

                    <hr>  

                    <pre id="blockchainDisplay"></pre>
                    <div class="message" onclick="messageClicked('{{ message.id }}')">
                        <strong>User:</strong> {{ message.message }}<br>
                        <strong>Output:</strong><div id="respond">{{ message.response }}</div> <br>
                        <strong>Timestamp:</strong> {{ message.timestamp }}
                        {% if message.topic != 'default_topic' %}
                            <br><strong>Topic:</strong> {{ message.topic }}
                        {% endif %}
                        {% if message.system != 'default_system' %}
                            <br><strong>System:</strong> {{ message.system }}
                        {% endif %}
                        Plasec: {{ message.score }}
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <script>
        function searchMessages() {
        let searchInput = searchBar.value.toLowerCase().trim();
        let messages = document.getElementsByClassName("messages mt-4");

        Array.from(messages).forEach(function(message) {
            let text = message.textContent.toLowerCase().trim();

            console.log("Message text:", text);  // Log the text of each message for debugging

            // Show the message if it matches the search input, is not empty, and does not contain "blockchain data"
            if (text.includes(searchInput) && text.length > 0 && text !== "blockchain data") {
                message.style.display = "";  // Show message
            } else {
                message.style.display = "none";  // Hide message
            }
        });
    }
        /// Select all buttons with the "playButton" class and add event listeners to each
document.addEventListener("DOMContentLoaded", function() {
    const playButtons = document.querySelectorAll(".playButton");
    const startButtons = document.querySelectorAll(".startButton");
    const searchBar = document.getElementById("searchBar");

    if (searchBar) {
        searchBar.addEventListener("keyup", searchMessages);
    } else {
        console.error("Search bar element not found.");
    }
    
    
 
    
    startButtons.forEach(button => {
        button.addEventListener("click", function() {
            window.location.href = "http://127.0.0.1:8000/play_in_telegram/11111/";
        });
    });
       
  
    playButtons.forEach(button => {
        button.addEventListener("click", function() {
            textcontent="click $$$underlineplay"
            

       if(button.textContent=="Share in Telegram")
         textcontent= document.getElementById("respond").innerHTML
         alert("share")
            const messageId=textcontent
            window.location.href = `http://127.0.0.1:8000/play_in_telegram/${messageId}/`;

        });
    });
 
});


        function deleteMessage(messageId) {
            fetch(`/delete_message/${messageId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Message deleted successfully!');
                    location.reload();  // Reload the page to update the message list
                } else {
                    alert('Error deleting message: ' + data.message);
                }
            });
        }

        function messageClicked(messageId) {
            fetch(`/message_clicked/${messageId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Message clicked! New score: ' + data.new_score);
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
        }

        function fetchBlockchain() {
            fetch('/get_blockchain/')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('blockchainDisplay').textContent = JSON.stringify(data, null, 4);
                });
        }
    </script>
</body>
</html>
